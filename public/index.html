<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inventory Management Admin Panel</title>
  <style>
    /* Reset & base */
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      margin: 0;
      background: #f4f6f8;
      color: #333;
    }
    h1, h2, h3 {
      margin: 0 0 15px 0;
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    /* Login Section */
    #login-section {
      max-width: 400px;
      margin: 60px auto;
      padding: 30px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      text-align: center;
    }
    #login-section input {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    #login-section input:focus {
      border-color: #007bff;
      outline: none;
    }
    #login-section button {
      width: 100%;
      padding: 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #login-section button:hover {
      background: #0056b3;
    }

    /* Admin Section */
    #admin-section {
      display: none;
    }
    #admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    #admin-header h1 {
      margin: 0;
      font-size: 2rem;
      color: #007bff;
    }
    #admin-header button {
      padding: 8px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #admin-header button:hover {
      background: #a71d2a;
    }

    /* Flex Layout for Sections */
    .flex-row {
      display: flex;
      gap: 40px;
    }
    .flex-column {
      flex: 1;
    }

    /* Items List */
    #item-list, #logs-list {
      list-style: none;
      padding-left: 0;
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fafafa;
    }
    #item-list li, #logs-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid #ddd;
      font-size: 0.95rem;
      transition: background-color 0.15s ease;
    }
    #item-list li:hover, #logs-list li:hover {
      background-color: #e9f1ff;
    }
    #item-list li:last-child, #logs-list li:last-child {
      border-bottom: none;
    }

    /* Buttons in lists */
    #item-list button {
      background: #dc3545;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background-color 0.3s ease;
    }
    #item-list button:hover {
      background: #a71d2a;
    }

    /* Form inputs */
    .form-group {
      margin-bottom: 15px;
    }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus {
      border-color: #007bff;
      outline: none;
    }
    button.primary-btn {
      padding: 12px 20px;
      background: #007bff;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    button.primary-btn:hover {
      background: #0056b3;
    }

    /* Section Titles */
    section {
      margin-bottom: 40px;
    }
    section h2, section h3 {
      color: #007bff;
      border-bottom: 2px solid #007bff;
      padding-bottom: 6px;
      margin-bottom: 20px;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .flex-row {
        flex-direction: column;
      }
    }

    #updateForm {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px;
      border: 2px solid #333;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="login-section">
      <h2>Login</h2>
      <input id="username" placeholder="Username" autocomplete="username" />
      <input id="password" placeholder="Password" type="password" autocomplete="current-password" />
      <button onclick="login()">Login</button>
    </div>

    <div id="admin-section">
      <div id="admin-header">
        <h1>Inventory Management Panel</h1>
        <button onclick="logout()">Logout</button>
      </div>

      <div class="flex-row">
        <div class="flex-column">
          <section>
            <h2>Current Items</h2>
            <ul id="item-list"></ul>
          </section>
<div id="overlay"></div>

    <!-- ✅ Update Item Modal -->
    <div id="updateForm">
      <h3>Update Item</h3>
      <input type="hidden" id="updateId">

      <label>Status:</label>
      <select id="updateStatus">
        <option value="available">Available</option>
        <option value="under maintenance">Under Maintenance</option>
        <option value="not available">Not Available</option>
      </select>
      <br><br>

      <label>Quantity:</label>
      <input type="number" id="updateQuantity" min="0">
      <br><br>

      <label>Price (₱):</label>
      <input type="number" id="updatePrice" min="0" step="0.01">
      <br><br>

      <button onclick="submitUpdate()">Save</button>
      <button onclick="cancelUpdate()">Cancel</button>
    </div>
  </div>
          <section>
            <h3>Add New Item</h3>
            <div class="form-group">
              <input id="item-name" placeholder="Name" />
            </div>
            <div class="form-group">
              <input id="item-quantity" type="number" min="0" placeholder="Quantity" />
            </div>
            <div class="form-group">
              <select id="item-status">
                <option value="available">Available</option>
                <option value="under maintenance">Under Maintenance</option>
                <option value="not available">Not Available</option>
              </select>
            </div>
            <div class="form-group">
              <input id="item-price" type="number" min="0" step="0.01" placeholder="Price" />
            </div>
            <button class="primary-btn" onclick="addItem()">Add Item</button>
          </section>

          <section>
            <h2>Place Order</h2>
            <div class="form-group">
              <input id="order-item-id" placeholder="Item ID" />
            </div>
            <div class="form-group">
              <input id="order-quantity" type="number" min="1" placeholder="Quantity" />
            </div>
              <div class="form-group">
            <input id="order-worker" placeholder="Worker Name" />
              </div>
            <button class="primary-btn" onclick="placeOrder()">Place Order</button>
          </section>
        </div>

        <div id="low-stock-box" style="color: red; font-weight: bold;"></div>

        <div class="flex-column">
          <section>
            <h2>Activity Logs</h2>
            <ul id="logs-list"></ul>
          </section>

          <!-- ✅ New Sales Section -->
          <section>
            <h2>Sales Report</h2>
            <div id="sales-report" style="padding:10px; border:1px solid #ddd; border-radius:6px; background:#fafafa;">
              Loading sales report...
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <script>
    let token = null;

    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!username || !password) return alert('Please enter username and password');

      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
        });
        const data = await res.json();

        if (res.ok && data.token) {
          token = data.token;
          document.getElementById('login-section').style.display = 'none';
          document.getElementById('admin-section').style.display = 'block';
          await loadItems();
          await loadLogs();
          await loadSalesReport();
          await checkLowStock();
        } else {
          alert('Login failed: ' + (data.error || 'Invalid credentials'));
        }
      } catch {
        alert('Error connecting to server');
      }
    }

    function logout() {
      token = null;
      document.getElementById('login-section').style.display = 'block';
      document.getElementById('admin-section').style.display = 'none';
    }

    async function loadItems() {
      try {
        const res = await fetch('/api/items', {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error("Failed to fetch items");

        const items = await res.json();
        const list = document.getElementById('item-list');
        list.innerHTML = '';

        items.forEach(item => {
          const li = document.createElement('li');

          const price = Number(item.price);
          const itemText = document.createTextNode(
            `ID: ${item.id} | ${item.name} - ${item.quantity} - ₱${price.toFixed(2)} `
          );
          li.appendChild(itemText);

          // status indicator
          let statusElem;
          if (item.status === 'available') {
            statusElem = document.createElement('button');
            statusElem.textContent = 'Available';
            statusElem.style.backgroundColor = 'green';
            statusElem.style.color = 'white';
            statusElem.style.border = 'none';
            statusElem.style.borderRadius = '5px';
            statusElem.style.padding = '3px 8px';
          } else if (item.status === 'not available') {
            statusElem = document.createElement('button');
            statusElem.textContent = 'Unavailable';
            statusElem.style.backgroundColor = 'red';
            statusElem.style.color = 'white';
            statusElem.style.border = 'none';
            statusElem.style.borderRadius = '5px';
            statusElem.style.padding = '3px 8px';
          } else if (item.status === 'under maintenance') {
            statusElem = document.createElement('span');
            statusElem.innerHTML = '🛠️';
            statusElem.title = 'Under Maintenance';
          } else {
            statusElem = document.createElement('span');
            statusElem.textContent = item.status;
          }
          li.appendChild(statusElem);

          // ✅ Update button (opens modal form)
          const updateBtn = document.createElement('button');
          updateBtn.textContent = 'Update';
          updateBtn.style.marginLeft = '10px';
          updateBtn.onclick = () => showUpdateForm(item);
          li.appendChild(updateBtn);

          // Delete button
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.onclick = () => deleteItem(item.id);
          li.appendChild(deleteBtn);

          list.appendChild(li);
        });

      } catch (err) {
        alert('Could not fetch items: ' + err.message);
      }
    }

    // ✅ Modal form functions
    function showUpdateForm(item) {
      document.getElementById('updateId').value = item.id;
      document.getElementById('updateStatus').value = item.status;
      document.getElementById('updateQuantity').value = item.quantity;
      document.getElementById('updatePrice').value = item.price;
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('updateForm').style.display = 'block';
    }

    function cancelUpdate() {
      document.getElementById('updateForm').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    async function submitUpdate() {
      const id = document.getElementById('updateId').value;
      const status = document.getElementById('updateStatus').value;
      const quantity = document.getElementById('updateQuantity').value;
      const price = document.getElementById('updatePrice').value;

      const res = await fetch(`/api/items/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
        body: JSON.stringify({ status, quantity, price })
      });

      if (res.ok) {
        alert('✅ Item updated!');
        cancelUpdate();
        loadItems();
      } else {
        const err = await res.json();
        alert('❌ Error: ' + err.error);
      }
    }
    async function deleteItem(itemId) {
      if (!confirm('Are you sure you want to delete this item?')) return;

      try {
        const res = await fetch(`/api/items/${itemId}`, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + token }
        });
        if (res.ok) {
          alert('Item deleted successfully');
          await loadItems();
        } else {
          alert('Failed to delete item');
        }
      } catch {
        alert('Error deleting item');
      }
    }

    async function addItem() {
      const name = document.getElementById('item-name').value.trim();
      const quantity = parseInt(document.getElementById('item-quantity').value);
      const status = document.getElementById('item-status').value;
      const price = parseFloat(document.getElementById('item-price').value);

      if (!name || isNaN(quantity) || quantity < 0 || isNaN(price) || price < 0) {
        alert('Please enter valid item details.');
        return;
      }

      try {
        const res = await fetch('/api/items', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
          body: JSON.stringify({ name, quantity, status, price }),
        });

        if (res.ok) {
          alert('Item added successfully');
          document.getElementById('item-name').value = '';
          document.getElementById('item-quantity').value = '';
          document.getElementById('item-price').value = '';
          await loadItems(); // ✅ Now waits for the items to load
        } else {
          const data = await res.json();
          alert(data.error || 'Failed to add item');
        }
      } catch (err) {
        console.error("Add item error:", err);
        alert('Error adding item');
      }
    }

    async function placeOrder() {
      const itemId = document.getElementById('order-item-id').value.trim();
      const quantity = parseInt(document.getElementById('order-quantity').value);
      const workerName = document.getElementById('order-worker').value.trim();

      if (!itemId || isNaN(quantity) || quantity < 1 || !workerName) {
        alert('Please enter valid order details and worker name.');
        return;
      }

      try {
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
          body: JSON.stringify({ item_id: itemId, quantity, user_id: 1, worker_name: workerName }),
        });

        if (res.ok) {
          alert('Order placed successfully');
          document.getElementById('order-item-id').value = '';
          document.getElementById('order-quantity').value = '';
          document.getElementById('order-worker').value = '';
          await loadItems();
          await loadLogs();
          await loadSalesReport();
          await checkLowStock();
        } else {
          const data = await res.json();
          alert(data.message || 'Failed to place order');
        }
      } catch {
        alert('Error placing order');
      }
    }

    async function loadLogs() {
      try {
        const res = await fetch('/api/logs', {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error("Failed to fetch logs");

        const logs = await res.json();
        const list = document.getElementById('logs-list');
        list.innerHTML = '';

        logs.forEach(log => {
          const li = document.createElement('li');
          const timeStr = new Date(log.timestamp).toLocaleString();
          const user = log.username || 'Unknown';
          const action = log.action || 'No action';
          const desc = log.description || 'No details';
          li.textContent = `[${timeStr}] ${user} → ${action} | ${desc}`;
          list.appendChild(li);
        });

        if (logs.length === 0) {
          const li = document.createElement('li');
          li.textContent = "No activity logs yet.";
          list.appendChild(li);
        }

      } catch (err) {
        console.error("Could not fetch logs:", err);
      }
    }

    // ✅ Load Sales Report
    async function loadSalesReport() {
      try {
        const res = await fetch('/api/orders/sales', {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) return;
        const data = await res.json();
        document.getElementById('sales-report').innerHTML =
          `📊 Total Sales: ₱${Number(data.total_sales).toFixed(2)}<br>🛒 Total Orders: ${data.total_orders}`;
      } catch (err) {
        console.error("Error loading sales report:", err);
        document.getElementById('sales-report').innerText = "Failed to load sales report.";
      }
    }

    // ✅ Check low & empty stock
    async function checkLowStock() {
      try {
        const res = await fetch('/api/items/low-stock', {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!res.ok) throw new Error("Failed to fetch low stock");

        const items = await res.json();
        const box = document.getElementById('low-stock-box');

        if (items.length > 0) {
          const warnings = items.map(item => {
            if (item.quantity === 0) {
              return `⚠️ Item "${item.name}" is OUT OF STOCK!`;
            } else {
              return `⚠️ Low Stock: ${item.name} (Qty: ${item.quantity})`;
            }
          });
          box.innerHTML = warnings.join('<br>');
        } else {
          box.innerHTML = '';
        }
      } catch (err) {
        console.error("Low stock check failed:", err);
      }
    }
  </script>
</body>
</html>
